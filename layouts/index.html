{{/* current series is the latest */}}
{{- $currentSeries := (index .Site.Taxonomies.series.Alphabetical.Reverse 0) -}}
{{/* current show is one with Now between start and end */}}
{{/* initialize with the latest show and event */}}
{{- range first 1 (where $currentSeries.Pages.ByDate.Reverse "Section" "eq" "show") -}}
    {{- $.Scratch.SetInMap "heros" "100" . -}}
{{- end -}}
{{- range first 1 (where $currentSeries.Pages.ByDate.Reverse "Section" "eq" "event") -}}
    {{- $.Scratch.SetInMap "heros" "200" . -}}
{{- end -}}
{{/* next show is the earliest one where the start date is in the future */}}
{{- range where $currentSeries.Pages.ByDate "Section" "in" (slice "show" "event") -}}
    {{/* show starts on the first date in the showtimes array */}}
    {{- $start := (time (index .Params.showtimes 0).time ) -}}
    {{/* show ends on the last date in the showtimes array */}}
    {{- $end := (time (index .Params.showtimes (sub (len .Params.showtimes) 1) ).time ) -}}
    {{- if gt $end.Unix .Now.Unix -}}
        {{/* it's either running now or it's in the future */}}
        {{- if eq .Section "show" -}}
            {{/* show weight is always 100 */}}
            {{- if lt $start.Unix (time (index (index ($.Scratch.Get "heros") "100").Params.showtimes 0).time ).Unix -}}
                {{- $.Scratch.SetInMap "heros" "100" . -}}
            {{- end -}}
        {{- else -}}
            {{/* event weight is always 200 */}}
            {{- if lt $start.Unix (time (index (index ($.Scratch.Get "heros") "200").Params.showtimes 0).time ).Unix -}}
                {{- $.Scratch.SetInMap "heros" "200" . -}}
            {{- end -}}
        {{- end -}}
    {{- end -}}
{{- end -}}

{{/* by default, ordered by weight then by date */}}
{{- range $index, $page := where (where .Data.Pages "Section" "special") ".Params.is_active" true -}}
    {{- if .Params.weight }}
        {{- $.Scratch.SetInMap "heros" .Params.weight . -}}
    {{- else -}}
        {{/* this weight should be 300, 400, 500 as we loop */}}
        {{- $weight := (add (mul (add $index 1) 100) 200) -}}
        {{- $.Scratch.SetInMap "heros" ($weight | string) . -}}
    {{- end -}}
{{- end -}}

{{- .Scratch.Set "heros" ($.Scratch.Get "heros") -}}

<html xmlns="http://www.w3.org/1999/xhtml"
  {{with .Site.LanguageCode}} xml:lang="{{.}}" lang="{{.}}"{{end}}>

  <head>
    {{- partial "head.html" . -}}
</head>
	{{- partial "nav_hidden.html" . -}}
	<div id="panel">
	  {{- partial "nav.html" . -}}

	  <!-- slider -->
	  <div class="slider-wrap">
	      <div class="slider" id="slider">
	          <div class="holder">

	              {{- range $weight, $page := ($.Scratch.GetSortedMapValues "heros") -}}
	              <div class="slide" style="background-image: url({{ partial "hero.html" . }})">
	                  <span class="slide-text">
	                      <span class="img-text-background">
	                          <b>Next {{ .Type | title }}:</b>
	                          {{ .Title | markdownify }}
	                      </span>
	                  </span>
	              </div>
	              {{- end -}}

	          </div>
	      </div>
	      <nav class="slider-nav" id="slider-nav">
	          <span class="fa fa-chevron-left" id="control-left" aria-hidden="true"></span>
	          <span class="fa fa-chevron-down" id="control-down" aria-hidden="true"></span>
	          <span class="fa fa-chevron-right" id="control-right" aria-hidden="true"></span>
	      </nav>
	  </div>
		<!-- I can work on adding this back to the homepage in some format,
					but these styles are dead -->
	<!-- shows -->
	<!-- <div class="shows-section">
	  <div class="container">
	      <div class="row">
	          <div class="col-sm-12">
	              <h2 class="section-title">Upcoming Shows {{ $currentSeries.Name }}</h2>
	          </div>
	      </div>
	  </div>
	    <div class="upcoming-container">
	        {{/* all current pages in the "show" section */}}
	        {{- range where $currentSeries.Pages.ByDate "Section" "show" -}}
	        <div class="show">
	            {{ partial "show/poster.html" . }}
	            <div class="show-info">
	                <h3>
	                    <a href="/show/{{ .Params.series }}/{{ (.Title | urlize) }}">
	                        {{ .Title }}
	                    </a>
	                </h3>
	                {{ partial "show/dates.html" . }}
	            </div>
	        </div>
	        {{- end -}}
	    </div>
	</div>
	</div> -->
	<!-- call-to-action -->
	<div class="subscribe">
	    <div class="container">
	        <div class="row">
	            <div class="col-sm-12">
	                <p class="lead">Buy a season ticket pass. Do it. Do it right now.</p>
	                <p><a class="button" href="https://web.ovationtix.com/trs/store/34132/packages">Subscribe</a></p>
	            </div>
	        </div>
	    </div>
	</div>
	{{ partial "foot.html" . }}

    <!-- close panel div -->
    </div>

</body>
</html>
