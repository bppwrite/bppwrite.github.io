{{/* current series is the latest */}}
{{- $currentSeries := (index .Site.Taxonomies.series.Alphabetical.Reverse 0) -}}
{{/* current show is one with Now between start and end */}}
{{/* initialize with the latest show and event */}}
{{- range first 1 (where $currentSeries.Pages.ByDate.Reverse "Section" "eq" "show") -}}
    {{- $.Scratch.SetInMap "heros" "100" . -}}
{{- end -}}
{{- range first 1 (where $currentSeries.Pages.ByDate.Reverse "Section" "eq" "event") -}}
    {{- $.Scratch.SetInMap "heros" "200" . -}}
{{- end -}}
{{/* next show is the earliest one where the start date is in the future */}}
{{- range where $currentSeries.Pages.ByDate "Section" "in" (slice "show" "event") -}}
    {{/* show starts on the first date in the showtimes array */}}
    {{- $start := (time (index .Params.showtimes 0).time ) -}}
    {{/* show ends on the last date in the showtimes array */}}
    {{- $end := (time (index .Params.showtimes (sub (len .Params.showtimes) 1) ).time ) -}}
    {{- if gt $end.Unix .Now.Unix -}}
        {{/* it's either running now or it's in the future */}}
        {{- if eq .Section "show" -}}
            {{/* show weight is always 100 */}}
            {{- if lt $start.Unix (time (index (index ($.Scratch.Get "heros") "100").Params.showtimes 0).time ).Unix -}}
                {{- $.Scratch.SetInMap "heros" "100" . -}}
            {{- end -}}
        {{- else -}}
            {{/* event weight is always 200 */}}
            {{- if lt $start.Unix (time (index (index ($.Scratch.Get "heros") "200").Params.showtimes 0).time ).Unix -}}
                {{- $.Scratch.SetInMap "heros" "200" . -}}
            {{- end -}}
        {{- end -}}
    {{- end -}}
{{- end -}}

{{/* by default, ordered by weight then by date */}}
{{- range $index, $page := where (where .Data.Pages "Section" "special") ".Params.is_active" true -}}
    {{- if $page.Params.hero_weight }}
        {{- $.Scratch.SetInMap "heros" ($page.Params.hero_weight | string) . -}}
    {{- else -}}
        {{/* this weight should be 300, 400, 500 as we loop */}}
        {{- $weight := (add (mul (add $index 1) 100) 200) -}}
        {{- $.Scratch.SetInMap "heros" ($weight | string) . -}}
    {{- end -}}
{{- end -}}

<html xmlns="http://www.w3.org/1999/xhtml"
    {{with .Site.LanguageCode}} xml:lang="{{.}}" lang="{{.}}"{{end}}>

<head>
    {{- partial "head.html" . -}}
</head>

{{- partial "nav_hidden.html" . -}}

<div id="panel">

    {{- partial "nav.html" . -}}

    <!-- slider -->
    <div class="slider-wrap">
        <div class="slider" id="slider">
            <div class="holder">

            {{- range $index, $page := ($.Scratch.GetSortedMapValues "heros") -}}
                {{- $heroPaths := (partial "heros.html" $page) -}}
                {{- if $heroPaths -}}
                    <div class="slide"
                        style="background-image: url({{ partial "hero.html" $page }})"
                        data-heros="{{ $heroPaths }}">
                        <span class="slide-text">
                            <span class="img-text-background">
                                <!-- <b>{{ $index }} Next {{ $page.Type | title }}:</b> -->
                                {{ $page.Title | markdownify }}
                            </span>
                        </span>
                    </div>
                {{- end -}}
            {{- end -}}

            </div>
        </div>
        <nav class="slider-nav" id="slider-nav">
            <span class="fa fa-chevron-left"
                id="control-left" aria-hidden="true"></span>
            <span class="fa fa-chevron-down"
                id="control-down" aria-hidden="true"></span>
            <span class="fa fa-chevron-right"
                id="control-right" aria-hidden="true"></span>
        </nav>
    </div>

    <!-- call-to-action -->
    <div class="container">
        <div class="subscribe">
            <div class="row">
                <div class="col-sm-12">
                    <h1>Buy a season ticket pass. Do it. Do it right now.</h1>
                    <a class="button"
                        href="https://web.ovationtix.com/trs/store/34132/packages">
                        Subscribe
                    </a>
                </div>
            </div>
        </div>
    </div>
    <!-- join us image sequence -->
    <div class="container img-sequence">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
                <div class="volunteer">
                    <h2>
                        <span class="img-text-background">
                            <a href="/get-involved/">Get Involved</a>
                        </span>
                    </h2>
                </div>
            </div>
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
                <div class="education">
                    <h2>
                        <span class="img-text-background">
                            <a href="/education/">Youth Education Program</a>
                        </span>
                    </h2>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="donate">
                    <h2>
                        <span class="img-text-background">
                            <a href="/support/">Support the BPP</a>
                        </span>
                    </h2>
                </div>
            </div>
        </div>
    </div>

    {{ partial "foot.html" . }}

</div>

</body>
</html>
